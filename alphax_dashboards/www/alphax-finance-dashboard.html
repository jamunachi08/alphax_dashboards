{% extends "templates/web.html" %}

{% block page_content %}
<body class="axd-body">
  <div class="axd-wrap" id="alphax_fin_dash">
    <div class="axd-topbar">
      <div class="axd-brand">
        <div>
          <h1 class="axd-title">AlphaX Finance Dashboard</h1>
          <div class="axd-subtitle">Computed from GL Entry and Account root_type (Income/Expense).</div>
        </div>
      </div>
      <div class="axd-nav">
        <a href="/alphax-crm-dashboard" data-nav="crm">CRM</a>
        <a href="/alphax-finance-dashboard" data-nav="finance">Finance</a>
        <a href="/alphax-hrms-management-dashboard" data-nav="hr_mgmt">HRMS Management</a>
        <a href="/alphax-hrms-self-service-dashboard" data-nav="hr_self">HRMS Self Service</a>
      </div>
    </div>

    <div class="axd-filters">
      <div class="axd-field">
        <label>From Date</label>
        <input type="date" data-f="from_date">
      </div>
      <div class="axd-field">
        <label>To Date</label>
        <input type="date" data-f="to_date">
      </div>
      <div class="axd-field" data-only="company">
        <label>Company</label>
        <select data-f="company"></select>
      </div>
      <div class="axd-field" data-only="cost_center">
        <label>Cost Center</label>
        <select data-f="cost_center"></select>
      </div>
      <div class="axd-field" data-only="branch">
        <label>Branch</label>
        <select data-f="branch"></select>
      </div>
      <div class="axd-field" data-only="department">
        <label>Department</label>
        <select data-f="department"></select>
      </div>
      <button class="axd-btn" data-action="refresh">Refresh</button>
    </div>

    <div class="axd-grid" data-zone="content"></div>
    <div class="axd-note" data-zone="note"></div>
  </div>
</body>

<script>
  (function(){
    if(!window.frappe) return;
    if(!AXD.ensureLogin()) return;

    const root = document.getElementById("alphax_fin_dash");
    const zone = root.querySelector('[data-zone="content"]');
    const note = root.querySelector('[data-zone="note"]');

    // nav active
    const active = "alphax_dashboards.api.finance.get_finance_summary".includes("crm") ? "crm" :
                   "alphax_dashboards.api.finance.get_finance_summary".includes("finance") ? "finance" :
                   "alphax_dashboards.api.finance.get_finance_summary".includes("hrms") ? ("alphax_fin_dash".includes("self") ? "hr_self" : "hr_mgmt") : "";
    root.querySelectorAll(".axd-nav a").forEach(a=>{
      if(a.getAttribute("data-nav")===active) a.classList.add("active");
    });

    // defaults
    const from = root.querySelector('[data-f="from_date"]');
    const to = root.querySelector('[data-f="to_date"]');
    to.value = AXD.today();
    from.value = AXD.daysAgo(30);

    function setSelect(select, rows, placeholder){
      select.innerHTML = "";
      const opt0=document.createElement("option");
      opt0.value=""; opt0.textContent=placeholder || "All";
      select.appendChild(opt0);
      (rows||[]).forEach(r=>{
        const o=document.createElement("option");
        o.value = r.value;
        o.textContent = r.label;
        select.appendChild(o);
      });
    }

    async function loadMasters(){
      // Show/hide filters per page
      const only = {
        company: root.querySelector('[data-only="company"]'),
        cost_center: root.querySelector('[data-only="cost_center"]'),
        branch: root.querySelector('[data-only="branch"]'),
        department: root.querySelector('[data-only="department"]'),
      };

      // default: show company always (ERPNext multi-company)
      if(only.company) only.company.style.display = "flex";

      // per page
      const want = {
        cost_center: active==="finance",
        branch: active.startsWith("hr"),
        department: active.startsWith("hr"),
      };
      if(only.cost_center) only.cost_center.style.display = want.cost_center ? "flex" : "none";
      if(only.branch) only.branch.style.display = want.branch ? "flex" : "none";
      if(only.department) only.department.style.display = want.department ? "flex" : "none";

      // Load options using frappe.db.get_list via /api/method/frappe.client.get_list
      async function getList(doctype, fields){
        const res = await AXD.call("frappe.client.get_list", {
          doctype,
          fields: fields || ["name"],
          limit_page_length: 999
        });
        return res || [];
      }

      try{
        const companies = await getList("Company", ["name"]);
        setSelect(root.querySelector('[data-f="company"]'), companies.map(x=>({value:x.name, label:x.name})), "All Companies");
      }catch(e){}

      if(want.cost_center){
        try{
          const ccs = await getList("Cost Center", ["name"]);
          setSelect(root.querySelector('[data-f="cost_center"]'), ccs.map(x=>({value:x.name, label:x.name})), "All Cost Centers");
        }catch(e){}
      }

      if(want.branch){
        try{
          const bs = await getList("Branch", ["name"]);
          setSelect(root.querySelector('[data-f="branch"]'), bs.map(x=>({value:x.name, label:x.name})), "All Branches");
        }catch(e){}
      }

      if(want.department){
        try{
          const ds = await getList("Department", ["name"]);
          setSelect(root.querySelector('[data-f="department"]'), ds.map(x=>({value:x.name, label:x.name})), "All Departments");
        }catch(e){}
      }
    }

    function kpiCard(title, value, detail, chip){
      return `
        <div class="axd-card axd-span-3">
          <h3>${title}</h3>
          <div class="axd-kpi">
            <div>
              <div class="v">${value}</div>
              <div class="d">${detail||""}</div>
            </div>
            ${chip ? `<div class="chip">${chip}</div>`:""}
          </div>
        </div>`;
    }

    function tableCard(title, headers, rows){
      const th = headers.map(h=>`<th>${h}</th>`).join("");
      const tr = rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("");
      return `
        <div class="axd-card axd-span-6">
          <h3>${title}</h3>
          <table class="axd-table">
            <thead><tr>${th}</tr></thead>
            <tbody>${tr || `<tr><td colspan="${headers.length}">No data</td></tr>`}</tbody>
          </table>
        </div>`;
    }

    function sparkCard(title, points){
      const id = "spark_" + Math.random().toString(16).slice(2);
      setTimeout(()=>{
        const el = document.getElementById(id);
        if(el) AXD.svgSparkline(el, points || []);
      }, 0);
      return `
        <div class="axd-card axd-span-6">
          <h3>${title}</h3>
          <div class="axd-spark" id="${id}"></div>
        </div>`;
    }

    function badge(v){
      if(v===null || v===undefined) return "";
      const n=Number(v);
      if(!isFinite(n)) return "";
      if(n>=0) return `<span class="axd-badge ok">OK</span>`;
      return `<span class="axd-badge danger">NEG</span>`;
    }

    async function refresh(){
      zone.innerHTML = "";
      note.textContent = "Loading...";
      const args = {
        from_date: from.value,
        to_date: to.value,
        company: root.querySelector('[data-f="company"]')?.value || null,
        cost_center: root.querySelector('[data-f="cost_center"]')?.value || null,
        branch: root.querySelector('[data-f="branch"]')?.value || null,
        department: root.querySelector('[data-f="department"]')?.value || null,
      };

      // remove nulls
      Object.keys(args).forEach(k=>{ if(args[k]===null) delete args[k]; });

      try{
        const data = await AXD.call("alphax_dashboards.api.finance.get_finance_summary", args);
        if(data && data.error){
          note.textContent = data.error;
          return;
        }
        render(data || {});
      }catch(e){
        console.error(e);
        note.textContent = "Failed to load. Check console and server logs.";
      }
    }

    function render(data){
      note.textContent = "";
      const k = data.kpis || {};

      // Page-specific render blocks
      let html = "";

      if(active==="crm"){
        html += kpiCard("Leads Created", AXD.fmt(k.leads_created||0), `Range: ${data.range?.from_date} → ${data.range?.to_date}`);
        html += kpiCard("Total Leads", AXD.fmt(k.total_leads||0), "All time");
        html += kpiCard("Open Opportunities", AXD.fmt(k.open_opportunities||0), "Current pipeline");
        html += kpiCard("Open Opp Value", AXD.fmt(k.open_opp_value||0, 2), "Base currency", "SAR");
        html += kpiCard("Quotations", AXD.fmt(k.quotations_created||0), "Created in range");
        html += kpiCard("Sales Orders", AXD.fmt(k.sales_orders_created||0), "Created in range");

        html += sparkCard("Lead Trend (Daily)", (data.trend||[]));

        const owners = (data.top_owners||[]).map(r=>[r.owner, AXD.fmt(r.count)]);
        html += tableCard("Top Lead Owners", ["Owner", "Leads"], owners);
      }

      if(active==="finance"){
        html += kpiCard("Income", AXD.fmt(k.income||0, 2), `Range: ${data.range?.from_date} → ${data.range?.to_date}`, "SAR");
        html += kpiCard("Expenses", AXD.fmt(k.expenses||0, 2), "From GL Entry (root_type=Expense)", "SAR");
        html += kpiCard("Profit", AXD.fmt(k.profit||0, 2), "Income - Expenses", badge(k.profit||0));
        html += kpiCard("Company", data.filters?.company || "All", "Filter");

        html += sparkCard("Profit Trend (Daily)", (data.trend||[]));

        const top = (data.top_expenses||[]).map(r=>[r.account, AXD.fmt(r.amount||0, 2)]);
        html += tableCard("Top Expense Accounts", ["Account", "Amount"], top);
      }

      if(active==="hr_mgmt" || active==="hr_self"){
        html += kpiCard("Active Employees", AXD.fmt(k.active_employees||0), `Range: ${data.range?.from_date} → ${data.range?.to_date}`);
        html += kpiCard("New Hires", AXD.fmt(k.new_hires||0), "Date of Joining in range");
        html += kpiCard("Exits", AXD.fmt(k.exits||0), "Relieving date in range");
        html += kpiCard("Approved Leaves", AXD.fmt(k.approved_leaves||0), "Approved in range");

        const a = data.attendance || {};
        html += tableCard("Attendance Summary", ["Status", "Count"], [
          ["Present", AXD.fmt(a.present||0)],
          ["Absent", AXD.fmt(a.absent||0)],
          ["On Leave", AXD.fmt(a.on_leave||0)],
        ]);

        html += sparkCard("Hiring Trend (Daily)", (data.trend||[]));
      }

      zone.innerHTML = html || '<div class="axd-card axd-span-12"><h3>No content</h3></div>';
      note.textContent = "Tip: if data looks empty, confirm you have records in the selected date range and the module is installed.";
    }

    root.querySelector('[data-action="refresh"]').addEventListener("click", refresh);
    loadMasters().then(refresh);
  })();
</script>
{% endblock %}
